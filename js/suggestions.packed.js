(function($){$.extend($.fn,{suggestions:function(options){var defaults={url:null,param:"k",max_rows:5,multiples:false,unique:false,debug:false,cleaning:true};var set=$.extend(defaults,options);if(!set.url){console.log('please set the url option in  suggestions plugin!');return false}var tc=0;var d=set.debug;var mr=set.max_rows;var el=this;var ex,ey,ew,eh;var updaterect=function(){ex=el.position().top;ey=el.position().left;ew=el.outerWidth();eh=el.outerHeight();sel.css({width:ew+'px',left:ex+'px',top:(eh+ey)+'px'});if(d)console.log('updaterect()\n\tfield width =  '+ew+'\n\tfield height = '+eh)}var lk=null;var eid=el.attr('id')+'-suggestions';el.wrap('<div class="suggestions" style="position:relative">')el.after('<select id="'+eid+'" size="2" class="suggestions-dropdown" style="position:absolute;z-index:9999"></select>');var sel=$('#'+eid);if(d)console.log('load suggestions plugin: #'+eid);sel.hide();if(d)console.log('hide suggestions plugin: #'+eid);sel.click(function(){var t=sel.find('option:selected').text();if(set.multiples){elt=el.val();if(elt.indexOf(',')>0){ta=elt.split(',');ta.pop();ta.push(t);if(set.unique){var i=0;var ua=[]while(i<ta.length){if(ua.indexOf(ta[i])==-1)ua.push(ta[i].trim())i++}ta=ua}t=ta.toString()}if(set.cleaning){nt=t.replace(/\s/g,'').replace(/,/,', ').replace(/,$/,'');if(d)console.log('cleaning suggestions  plugin #'+eid+'\n\tfrom : "'+t+'" \n\tto : "'+nt+'"');t=nt}}el.val(t);reset()})$(window).on('resize',function(e){updaterect()});$(el).on('focus',function(e){updaterect()});$('html').click(function(){reset()});var reset=function(){sel.find('option').remove();sel.hide();if(d)console.log('reset suggestions plugin: #'+eid)}var request=function(q){var url=set.url+'?'+set.param+'='+q;tc++;if(d)console.log('send request '+tc+' to '+set.url+'\n\tparam = '+set.param+'\n\tvalue = '+q);$.getJSON(url,function(data){reset();var i=0;var opts='';var ds=data.suggestions;var n=ds.length if(n>0){if(sel.is(':hidden')){sel.show();if(d)console.log('show suggestions plugin : #'+sel.attr('id'))}if(n<mr)r=n;else if(n>mr)r=mr;if(n==1)r=2 sel.attr('size',r);while(i<n){opt='<option value="'+ds[i]+'">'+ds[i]+'</option>';opts+=opt;i++}sel.append(opts)}else{sel.hide()}})}el.keyup(function(e){var q=el.val();var c=e.keyCode;if(c==188&&set.multiples){reset();return}if(q.trim()!=''){if(q.length>1&&q.length%2==0){if(lk!=32){if(set.multiples){qa=q.split(',')q=qa.pop()if(q.trim()==''){reset();return}}request(q.trim())}}}else{reset()}lk=c})}})})(window.Zepto||window.jQuery)
